<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Heartline ‚Äî Romance Messenger</title>
<style>
  :root{
    --bg1:#fde2ee; --bg2:#e8f2ff;
    --card:#ffffff; --ink:#111; --muted:#666; --rose:#ff6fa3; --rose2:#ff86b2;
    --pill:#f7f1f7; --accent:#7a5cff; --ok:#2fc37a; --warn:#ffcc00;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
  body{background:#0b0f16;color:var(--ink);display:flex;align-items:center;justify-content:center}
  /* phone frame */
  .phone{width:420px;max-width:100vw;height:860px;max-height:100vh;background:#fff;border-radius:26px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden;position:relative}
  .statusbar{position:absolute;inset:0 0 auto 0;height:40px;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:15;font-weight:600}
  .statusbar span{background:rgba(0,0,0,.35);padding:6px 10px;border-radius:14px;backdrop-filter:saturate(1.2) blur(6px);font-size:12px}
  /* screens */
  .screen{position:absolute;inset:0;overflow:auto;display:none}
  .screen.active{display:block}
  /* start */
  .start{
    background-image:linear-gradient(180deg, #f9d7e6 0%, #fbe9f2 40%, #f3d7ea 100%), url('assets/start-art.jpg');
    background-size:cover;background-position:center;
  }
  .start-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:24px}
  .start-logo{position:absolute;top:44px;left:0;right:0;text-align:center;font-family:Georgia, 'Times New Roman', serif;font-size:56px;color:#fff;text-shadow:0 4px 20px rgba(0,0,0,.25)}
  .start-btn{margin:16px auto 32px auto;background:linear-gradient(180deg,var(--rose),var(--rose2));color:#fff;border:none;border-radius:24px;padding:16px 28px;font-weight:800;font-size:20px;box-shadow:0 10px 24px rgba(255,105,150,.35)}
  /* name modal */
  dialog{border:none;border-radius:16px;max-width:88%;padding:0;overflow:hidden}
  .modal{background:#fff}
  .modal-hd{padding:18px 18px 0 18px}
  .modal-bd{padding:18px}
  .modal-ft{display:flex;gap:10px;justify-content:flex-end;padding:0 18px 18px 18px}
  .hero-row{display:flex;gap:16px;align-items:center}
  .hero{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#f5cbd9,#ffe2f0);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .hero:before{content:"";width:60px;height:60px;background:url('assets/hero-circle.png') center/cover no-repeat, radial-gradient(#d1a,#d9f);border-radius:50%;filter:saturate(1.1)}
  .input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid #ddd;font-size:16px}
  .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  /* home */
  .home{
    background:
      linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.90)),
      url('assets/sakura-closeup.jpg');
    background-size:cover;background-position:center;
  }
  .home .grid{padding:64px 20px 20px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  .app{background:#fff;border-radius:22px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;box-shadow:0 6px 10px rgba(0,0,0,.08)}
  .app .ico{width:54px;height:54px;border-radius:14px;display:grid;place-items:center;color:#fff;font-size:26px}
  .app .lbl{font-weight:800}
  .ico.msg{background:linear-gradient(135deg,#ff7eb3,#ff65a3)}
  .ico.ph{background:linear-gradient(135deg,#00c36f,#00a455)}
  .ico.gal{background:linear-gradient(135deg,#7a5cff,#8aa6ff)}
  .ico.clk{background:linear-gradient(135deg,#ff7a59,#ffb86c)}
  .ico.note{background:linear-gradient(135deg,#5ec8ff,#76e1ff)}
  .ico.set{background:linear-gradient(135deg,#b08cff,#d2b3ff)}
  .toast{position:absolute;left:16px;right:16px;bottom:24px;background:#fff;border-radius:14px;padding:12px 14px;box-shadow:0 10px 20px rgba(0,0,0,.15);display:none}
  .toast.show{display:block}
  /* messages list */
  .list{padding:60px 14px 16px 14px;background:linear-gradient(#f7f7fb,#f2f4f8)}
  .thread{display:flex;gap:12px;background:#fff;border-radius:18px;padding:14px;margin:10px 0;align-items:center;box-shadow:0 3px 10px rgba(0,0,0,.05)}
  .av{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;font-weight:900;color:#fff}
  .av.m{background:#ff85b3}.av.r{background:#8aa6ff}.av.n{background:#8be38f}.av.v{background:#c2b5ff}
  .meta{flex:1}
  .meta .tit{font-weight:900}
  .meta .sub{color:#666;margin-top:3px}
  .lock{font-size:12px;color:#999}
  .back{position:absolute;left:10px;top:44px;border:none;background:#fff;border-radius:13px;padding:8px 10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  /* chat */
  .chat{background:linear-gradient(180deg,#ffe9f2,#f5f0ff)}
  .bar{position:sticky;top:40px;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);display:flex;align-items:center;gap:10px;padding:12px 14px;font-weight:900;border-bottom:1px solid #eee;z-index:5}
  .msgs{padding:14px 14px 90px 14px}
  .bubble{background:#fff;padding:12px 14px;border-radius:16px;max-width:80%;box-shadow:0 2px 8px rgba(0,0,0,.08);margin:10px 0}
  .bubble.me{margin-left:auto;background:linear-gradient(135deg,#7a5cff,#9f8bff);color:#fff}
  .who{font-size:12px;font-weight:900;color:#777;margin:2px 0 0 4px}
  .choices{position:fixed;left:0;right:0;bottom:20px;padding:0 14px;display:flex;flex-direction:column;gap:10px}
  .choice{border:none;border-radius:20px;background:linear-gradient(180deg,#ff7eb3,#ff9ac7);color:#fff;font-weight:900;padding:12px}
  .next{position:fixed;right:16px;bottom:20px;border:none;border-radius:20px;background:#111;color:#fff;padding:10px 14px;font-weight:900}
  .pill{position:absolute;right:10px;top:-6px;background:#ff496f;color:#fff;font-size:11px;border-radius:10px;padding:2px 6px}
  /* title bars */
  .title{position:absolute;top:44px;left:0;right:0;text-align:center;font-weight:900}
</style>
</head>
<body>
  <div class="phone" id="phone">
    <div class="statusbar"><span id="sb-time">--:--</span><span id="sb-date">‚Äî</span><span id="sb-batt">92%</span></div>

    <!-- START -->
    <section class="screen start active" id="scr-start">
      <div class="start-inner">
        <div class="start-logo">Heartline</div>
        <button class="start-btn" id="btnStart">Start</button>
      </div>
    </section>

    <!-- NAME -->
    <section class="screen home" id="scr-name">
      <div class="title">Welcome</div>
      <dialog id="nameDlg">
        <div class="modal">
          <div class="modal-hd"><h3 style="margin:0">Enter your name</h3></div>
          <div class="modal-bd">
            <div class="hero-row">
              <div class="hero"></div>
              <input id="inpName" class="input" maxlength="16" placeholder="Your name" />
            </div>
            <div style="color:#777;margin-top:8px;font-size:12px">It will appear in English dialogues.</div>
          </div>
          <div class="modal-ft">
            <button class="btn" id="cancelName">Cancel</button>
            <button class="btn primary" id="okName">OK</button>
          </div>
        </div>
      </dialog>
      <script>/* open modal immediately */</script>
    </section>

    <!-- HOME -->
    <section class="screen home" id="scr-home">
      <div class="title">Home</div>
      <div class="grid">
        <div class="app" data-open="messages"><div class="ico msg">üí¨</div><div class="lbl">Messages <span id="i-badge" class="pill" style="display:none">1</span></div></div>
        <div class="app"><div class="ico ph">üìû</div><div class="lbl">Phone</div></div>
        <div class="app"><div class="ico gal">üñºÔ∏è</div><div class="lbl">Gallery</div></div>
        <div class="app"><div class="ico clk">‚è∞</div><div class="lbl">Clock</div></div>
        <div class="app"><div class="ico note">üìù</div><div class="lbl">Notes</div></div>
        <div class="app" data-open="settings"><div class="ico set">‚öôÔ∏è</div><div class="lbl">Settings</div></div>
      </div>
      <div id="toast" class="toast">New message from <b>Maya</b> üí¨</div>
    </section>

    <!-- MESSAGES -->
    <section class="screen" id="scr-msgs">
      <button class="back" id="back1">‚óÄ</button>
      <div class="title">Messages</div>
      <div class="list" id="threads"></div>
    </section>

    <!-- CHAT -->
    <section class="screen chat" id="scr-chat">
      <div class="bar"><button class="back" id="back2">‚óÄ</button><div id="chatTitle">Chat</div></div>
      <div class="msgs" id="msgs"></div>
      <div class="choices" id="choices"></div>
      <button class="next" id="btnNext" style="display:none">Next ‚ñ∂</button>
    </section>

    <!-- SETTINGS -->
    <section class="screen" id="scr-settings">
      <button class="back" id="back3">‚óÄ</button>
      <div class="title">Settings</div>
      <div class="list" style="padding-top:70px">
        <div class="thread" style="cursor:pointer" id="btnReset">
          <div class="av v">‚ö†Ô∏è</div>
          <div class="meta"><div class="tit">Reset save</div><div class="sub">Clear progress and show Start screen again</div></div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ======= UTIL / STATE ======= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const SCR = { start:$('#scr-start'), name:$('#scr-name'), home:$('#scr-home'), msgs:$('#scr-msgs'), chat:$('#scr-chat'), settings:$('#scr-settings') };
const ST0 = { playerName:'', inboxOrder:['maya','riven','noah','victor'], previews:{}, threads:{}, flags:{firstRun:true, rivenUnlocked:false, noahUnlocked:false, victorUnlocked:false} };
let ST = load();

function save(){ localStorage.setItem('heartline_save', JSON.stringify(ST)); }
function load(){ try{ return JSON.parse(localStorage.getItem('heartline_save'))||structuredClone(ST0);}catch{ return structuredClone(ST0);} }
function reset(){ localStorage.removeItem('heartline_save'); ST = structuredClone(ST0); show('start'); }

function show(id){
  $$('.screen').forEach(sc=>sc.classList.remove('active'));
  if(id==='start'){ SCR.start.classList.add('active'); return; }
  if(id==='name'){
    SCR.name.classList.add('active');
    $('#nameDlg').showModal();
    return;
  }
  document.body.offsetHeight; // reflow
  SCR[id].classList.add('active');
  if(id==='home'){ renderHome(); }
  if(id==='msgs'){ renderThreads(); }
}

function timeTick(){
  const now = new Date();
  const h = now.getHours().toString().padStart(2,'0');
  const m = now.getMinutes().toString().padStart(2,'0');
  $('#sb-time').textContent = `${h}:${m}`;
  $('#sb-date').textContent = now.toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'});
}
setInterval(timeTick, 1000); timeTick();

/* ======= START FLOW ======= */
$('#btnStart').onclick = ()=>{ ST.flags.firstRun=false; save(); show('name'); };

$('#okName').onclick = ()=>{
  const v = $('#inpName').value.trim();
  if(!v){ $('#inpName').focus(); return; }
  ST.playerName = v; save(); $('#nameDlg').close(); startChapter1();
};
$('#cancelName').onclick = ()=>{ $('#nameDlg').close(); startChapter1(); };

function boot(){
  // try to use sakura image, else gradient stays
  const img = new Image();
  img.onload = ()=>{ SCR.home.style.backgroundImage = `linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.90)), url('assets/sakura-closeup.jpg')`; };
  img.src = 'assets/sakura-closeup.jpg';

  if(ST.flags.firstRun){ show('start'); }
  else { show('home'); }
}
document.addEventListener('DOMContentLoaded', boot);

/* ======= HOME ======= */
function renderHome(){
  // badge if new Maya message flagged
  $('#i-badge').style.display = (ST.previews['maya'] && !ST.threads['maya']?.seen)?'inline-block':'none';
}

$('.home').addEventListener('click', (e)=>{
  const box = e.target.closest('.app');
  if(!box) return;
  const to = box.dataset.open;
  if(to==='messages'){ show('msgs'); }
  if(to==='settings'){ show('settings'); }
});
$('#back1').onclick = ()=>show('home');
$('#back2').onclick = ()=>{ show('msgs'); };
$('#back3').onclick = ()=>show('home');
$('#btnReset').onclick = ()=>{ if(confirm('Reset all progress?')) reset(); };

/* ======= INBOX RENDER ======= */
function renderThreads(){
  // ensure presence of default threads
  const T = ST.threads;
  ST.inboxOrder.forEach(id=>{ if(!T[id]) T[id]=[]; });
  // gate: locking
  const rows = ST.inboxOrder.map(id=>{
    const locked = (id==='riven' && !ST.flags.rivenUnlocked) || (id==='noah' && !ST.flags.noahUnlocked) || (id==='victor' && !ST.flags.victorUnlocked);
    const avCls = {maya:'m', riven:'r', noah:'n', victor:'v'}[id];
    const name = cap(id);
    const prev = ST.previews[id] || (locked?'Locked':(T[id].length?T[id][T[id].length-1].text:''));
    return `
      <div class="thread" data-id="${id}" ${locked?'data-locked="1"':''}>
        <div class="av ${avCls}">${name[0]}</div>
        <div class="meta">
          <div class="tit">${name}</div>
          <div class="sub">${locked?'<span class="lock">Locked</span>':escape(prev)}</div>
        </div>
      </div>`;
  }).join('');
  $('#threads').innerHTML = rows;

  // handle new Maya message queued by flags
  if(ST.flags.newMayaMsg){
    const t = ST.threads['maya']||[];
    t.push({from:'maya', text:"Okay, listen‚Ä¶ I think he's hiding something."});
    ST.threads['maya']=t;
    ST.previews['maya']="Okay, listen‚Ä¶ I think he's hiding something.";
    delete ST.flags.newMayaMsg;
    save();
  }

  // open
  $$('#threads .thread').forEach(row=>{
    row.onclick = ()=>{
      if(row.dataset.locked) return;
      openChat(row.dataset.id);
    };
  });
}

/* ======= CHAT ENGINE ======= */
const CHAT = $('#msgs'), CHO = $('#choices'), NXT = $('#btnNext');
let curId=null, curSeq=null, curPtr=0;

function openChat(id){
  curId=id; $('#chatTitle').textContent = cap(id);
  CHAT.innerHTML=''; CHO.innerHTML=''; NXT.style.display='none';
  show('chat');

  // decide what to run:
  if(id==='maya' && !ST.flags.mayaSceneDone){ curSeq = Scenes.mayaIntro; }
  else if(id==='riven' && !ST.flags.rivenSceneDone){ curSeq = Scenes.rivenM1; }
  else if(id==='maya' && ST.flags.rivenSceneDone && !ST.flags.mayaScene2Done){ curSeq = Scenes.mayaScene2; }
  else { curSeq = []; } // free chat after scenes

  curPtr=0;
  if(curSeq.length) step();
  else renderHistoryOnly(id);
}

function renderHistoryOnly(id){
  CHAT.innerHTML='';
  const hist = ST.threads[id]||[];
  hist.forEach(m=>appendBubble(m.from, m.text));
  CHO.innerHTML=''; NXT.style.display='none';
}

function appendBubble(from, text){
  const b = document.createElement('div');
  b.className = 'bubble'+(from==='you'?' me':'');
  b.innerHTML = `<div class="who">${from==='you'?'You':cap(from)}</div>${escape(text)}`;
  CHAT.appendChild(b);
  CHAT.scrollTop = CHAT.scrollHeight;
}

// engine step
function step(){
  const node = curSeq[curPtr++];
  if(!node){ endSeq(); return; }
  if(node.from){ // message
    appendBubble(node.from, node.text.replaceAll('{name}', ST.playerName||'You'));
    // push to history
    const t = ST.threads[curId]||([]);
    t.push({from:node.from, text:node.text.replaceAll('{name}', ST.playerName||'You')});
    ST.threads[curId]=t; save();
    step(); // chain messages without waiting
    return;
  }
  if(node.choices){
    CHO.innerHTML = '';
    node.choices.forEach(ch=>{
      const btn = document.createElement('button');
      btn.className='choice';
      btn.textContent = ch.text;
      btn.onclick = ()=>{ appendBubble('you', ch.text); if(ch.aff){ ST.aff = ST.aff||{}; ST.aff[curId]=(ST.aff[curId]||0)+ch.aff; save(); } curSeq = ch.then; curPtr=0; step(); };
      CHO.appendChild(btn);
    });
    return;
  }
  if(node.next){ NXT.style.display='block'; NXT.onclick=()=>{ NXT.style.display='none'; step(); }; return; }
  if(node.sys){ node.sys(); step(); return; }
}

function endSeq(){
  CHO.innerHTML=''; NXT.style.display='none';
  // mark scene flags
  if(curSeq===Scenes.mayaIntro){ ST.flags.mayaSceneDone=true; ST.flags.rivenUnlocked=true; ST.previews['maya']="Okay, I have class ‚Äî text me later!"; save(); }
  if(curSeq===Scenes.rivenM1){
    ST.flags.rivenSceneDone=true;
    ST.previews['riven']="If you want answers, meet me at the riverside tonight.";
    // *** FIX: queue new Maya message + force preview update
    ST.flags.newMayaMsg = true;
    save();
    toast('New message from Maya üí¨');
  }
  if(curSeq===Scenes.mayaScene2){ ST.flags.mayaScene2Done=true; ST.flags.noahUnlocked=true; ST.previews['maya']="We‚Äôre meeting him tonight‚Ä¶ be careful."; save(); }

  renderThreads();
}

function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function escape(s){ return s.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
function toast(t){
  const el = $('#toast'); el.innerHTML=t; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 1800);
}

/* ======= SCENES ======= */
const Scenes = {
  /* Scene 1A ‚Äî Maya opens */
  mayaIntro: [
    { from:'maya', text:"Hey! Guess who texted me last night? üëÄ" },
    { choices:[
      { text:"Tell me already!", then:[ {from:'maya', text:"Riven."} ] },
      { text:"Let me guess‚Ä¶ Riven?", then:[ {from:'maya', text:"...you know me too well."} ] },
      { text:"You're glowing, Maya üòå", then:[ {from:'maya', text:"Stoppp, I'm not! (maybe a little)"} ] },
    ]},
    { from:'maya', text:"He wants to talk. Should I?" },
    { choices:[
      { text:"Go hear him out.", aff:+1, then:[ {from:'maya', text:"Okay‚Ä¶ I'll text you after class."} ] },
      { text:"Be careful.", aff:+1, then:[ {from:'maya', text:"Promise. I‚Äôll keep you posted."} ] },
      { text:"Ignore him.", aff:-1, then:[ {from:'maya', text:"I‚Ä¶ I can‚Äôt. Not yet."} ] },
    ]},
    { sys: ()=>{ ST.previews['maya']="Okay, I have class ‚Äî text me later!"; save(); } },
  ],

  /* Scene 1B ‚Äî Riven first contact */
  rivenM1: [
    { from:'riven', text:"‚Ä¶Are you there?" },
    { choices:[
      { text:"(Don't reply)", then:[
        {from:'riven', text:"‚Ä¶yeah. I probably deserve the silence."}
      ]},
      { text:"What do you want, Riven?", then:[
        {from:'riven', text:"Answers. And maybe a chance."}
      ]},
      { text:"You shouldn‚Äôt text me.", then:[
        {from:'riven', text:"Figures. You used to text me at 2AM just to send memes."}
      ]},
    ]},
    { from:'riven', text:"Maya said you‚Äôre still in town." },
    { from:'riven', text:"Do you ever think about‚Ä¶ that night?" },
    { choices:[
      { text:"I don't sleep much lately.", then:[ {from:'riven', text:"Meet me by the riverside. Tonight."} ] },
      { text:"No. And neither should you.", then:[ {from:'riven', text:"Then give me one chance to make it right."} ] },
      { text:"‚Ä¶Maybe.", then:[ {from:'riven', text:"7 PM. Same place."} ] },
    ]},
    { sys: ()=>{ ST.previews['riven']="If you want answers, meet me at the riverside tonight."; } },
  ],

  /* Scene 2 ‚Äî Maya after Riven chat (unlocks Noah) */
  mayaScene2: [
    { from:'maya', text:"Okay, listen‚Ä¶ I think he's hiding something." },
    { from:'maya', text:"If you meet him, I‚Äôm coming too. Deal?" },
    { choices:[
      { text:"Deal. We stick together.", aff:+1, then:[ {from:'maya', text:"Good. I‚Äôll bring snacks. Serious ambush prep."} ] },
      { text:"I‚Äôll handle it alone.", aff:-1, then:[ {from:'maya', text:"‚Ä¶Text me if anything feels off, okay?"} ] },
    ]},
    { from:'maya', text:"Also‚Ä¶ remember Noah from the caf√©? He asked for your number. I *might* have said yes." },
    { sys: ()=>{ ST.previews['maya']="We‚Äôre meeting him tonight‚Ä¶ be careful."; ST.flags.noahUnlocked=true; save(); } },
  ],
};

/* ======= START CHAPTER 1 ======= */
function startChapter1(){
  // seed previews if fresh
  if(!ST.previews['maya']) ST.previews['maya'] = "Hey! Guess who texted me last night? üëÄ";
  save();
  show('home');
  // show toast for first message
  $('#i-badge').style.display='inline-block';
  toast('New message from Maya üí¨');
}

/* ======= OPEN FROM INBOX BADGE ======= */
$('#threads').addEventListener('click', e=>{
  const row = e.target.closest('.thread');
  if(!row) return;
});

/* ======= STARTUP GUARD ======= */
window.addEventListener('load', ()=>{
  // if returning user and already past start
  if(!ST.flags.firstRun){ show('home'); }
});
</script>
</body>
</html>
